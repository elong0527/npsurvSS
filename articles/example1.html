<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example 1: Optimal randomization ratio â€¢ npsurvSS</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example 1: Optimal randomization ratio">
<meta property="og:description" content="npsurvSS">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">npsurvSS</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/npsurvSS.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic_functionalities.html">Basic functionalities</a>
    </li>
    <li>
      <a href="../articles/example1.html">Example 1: Optimal randomization ratio</a>
    </li>
    <li>
      <a href="../articles/example2.html">Example 2: Delayed treatment effect</a>
    </li>
    <li>
      <a href="../articles/project-plan.html">Grammer of Study Design Planning</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/godwinyung/npsurvSS/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example 1: Optimal randomization ratio</h1>
                        <h4 data-toc-skip class="author">Godwin Yung</h4>
            
            <h4 data-toc-skip class="date">2022-08-21</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/godwinyung/npsurvSS/blob/HEAD/vignettes/example1.Rmd" class="external-link"><code>vignettes/example1.Rmd</code></a></small>
      <div class="hidden name"><code>example1.Rmd</code></div>

    </div>

    
    
<p>We provide here code to replicate Figures 1C and 2 from Example 1 of our manuscript. We rely on R packages tidyverse and ggplot2 for cleaner coding and advanced visualizations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/godwinyung/npsurvSS" class="external-link">npsurvSS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<p>As described in Web Appendix C, we define ratio of events to patients, control median survival, and accrual duration as increasing functions of HR:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fun_hr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">HR</span>, <span class="va">k</span>, <span class="va">range.min</span>, <span class="va">range.max</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">HR</span><span class="op">-</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">0.9</span><span class="op">-</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">k</span><span class="op">*</span><span class="op">(</span><span class="va">HR</span><span class="op">-</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">k</span><span class="op">*</span><span class="op">(</span><span class="fl">0.9</span><span class="op">-</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">range.max</span><span class="op">-</span><span class="va">range.min</span><span class="op">)</span> <span class="op">+</span> <span class="va">range.min</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The actual assumptions are visualized below:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">HR.vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.9</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">HR.vec</span>, <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR.vec</span>, k<span class="op">=</span><span class="fl">5</span>, range.min<span class="op">=</span><span class="fl">0.6</span>, range.max<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Hazard ratio"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"d/n ratio"</span>,</span>
<span>     type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">HR.vec</span>, <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR.vec</span>, k<span class="op">=</span><span class="fl">0</span>, range.min<span class="op">=</span><span class="fl">6</span>, range.max<span class="op">=</span><span class="fl">24</span><span class="op">)</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Hazard ratio"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Control median survival (months)"</span>,</span>
<span>     type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">HR.vec</span>, <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR.vec</span>, k<span class="op">=</span><span class="fl">2.3</span>, range.min<span class="op">=</span><span class="fl">12</span>, range.max<span class="op">=</span><span class="fl">48</span><span class="op">)</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Hazard ratio"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Accrual duration (months)"</span>,</span>
<span>     type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-3-1.png" width="700"><img src="example1_files/figure-html/unnamed-chunk-3-2.png" width="700"><img src="example1_files/figure-html/unnamed-chunk-3-3.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="figure-1c">Figure 1C<a class="anchor" aria-label="anchor" href="#figure-1c"></a>
</h2>
<p>To calculate power across a vector of hazard ratios (<code>HR.vec</code>) and randomization ratio (<code>p1.vec</code>), we begin by initializing the output table. Note that, in addition to keeping track of the power, the table also keeps track of the number of expected events contributed by each arm. Also, for the sake of efficency, the range of scenarios covered in this exercise will be less than that in the manuscript. The resulting figure will therefore be coarser:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1.vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">p1.vec</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">HR.vec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  HR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">HR.vec</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">p1.vec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  accr_time <span class="op">=</span> <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR</span>, k<span class="op">=</span><span class="fl">2.3</span>, range.min<span class="op">=</span><span class="fl">12</span>, range.max<span class="op">=</span><span class="fl">48</span><span class="op">)</span>,</span>
<span>  d <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.9</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="fl">0.5</span><span class="op">/</span><span class="fl">0.5</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">HR</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="co"># schoenfeld 1981</span></span>
<span>  n <span class="op">=</span> <span class="va">d</span> <span class="op">/</span> <span class="fu">fun_hr</span><span class="op">(</span><span class="va">HR</span>, k<span class="op">=</span><span class="fl">5</span>, range.min<span class="op">=</span><span class="fl">0.6</span>, range.max<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span>,</span>
<span>  m <span class="op">=</span> <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR</span>, k<span class="op">=</span><span class="fl">0</span>, range.min<span class="op">=</span><span class="fl">6</span>, range.max<span class="op">=</span><span class="fl">24</span><span class="op">)</span>,</span>
<span>  total_time <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  power<span class="op">=</span><span class="fl">0</span>,</span>
<span>  events0<span class="op">=</span><span class="fl">0</span>,</span>
<span>  events1<span class="op">=</span><span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We then fill in the table using the functions <code>power_two_arm</code> and <code>exp_events</code> described in the vignette <strong>basic_functionalities</strong>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">optimal</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">R</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># scenario specific parameters</span></span>
<span>  <span class="va">p1</span>        <span class="op">&lt;-</span> <span class="va">optimal</span><span class="op">$</span><span class="va">p1</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">HR</span>        <span class="op">&lt;-</span> <span class="va">optimal</span><span class="op">$</span><span class="va">HR</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">accr_time</span> <span class="op">&lt;-</span> <span class="va">optimal</span><span class="op">$</span><span class="va">accr_time</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">d</span>         <span class="op">&lt;-</span> <span class="va">optimal</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">n</span>         <span class="op">&lt;-</span> <span class="va">optimal</span><span class="op">$</span><span class="va">n</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">m</span>         <span class="op">&lt;-</span> <span class="va">optimal</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># create arm objects</span></span>
<span>  <span class="va">arm0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_arm.html">create_arm</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">n</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p1</span><span class="op">)</span>,</span>
<span>                     accr_time<span class="op">=</span><span class="va">accr_time</span>,</span>
<span>                     accr_interval<span class="op">=</span><span class="va">accr_time</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>, <span class="co"># piecewise-uniform accrual</span></span>
<span>                     accr_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.25</span>,<span class="fl">0.7</span><span class="op">)</span>,</span>
<span>                     surv_scale<span class="op">=</span><span class="fu"><a href="../reference/per2haz.html">per2haz</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,</span>
<span>                     loss_scale<span class="op">=</span><span class="fu"><a href="../reference/per2haz.html">per2haz</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">*</span><span class="fl">0.05</span>,</span>
<span>                     follow_time<span class="op">=</span><span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="va">arm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_arm.html">create_arm</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">n</span><span class="op">*</span><span class="va">p1</span>,</span>
<span>                     accr_time<span class="op">=</span><span class="va">accr_time</span>,</span>
<span>                     accr_interval<span class="op">=</span><span class="va">accr_time</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                     accr_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.25</span>,<span class="fl">0.7</span><span class="op">)</span>,</span>
<span>                     surv_scale<span class="op">=</span><span class="fu"><a href="../reference/per2haz.html">per2haz</a></span><span class="op">(</span><span class="va">m</span><span class="op">/</span><span class="va">HR</span><span class="op">)</span>,</span>
<span>                     loss_scale<span class="op">=</span><span class="va">arm0</span><span class="op">$</span><span class="va">loss_scale</span>,</span>
<span>                     follow_time<span class="op">=</span><span class="fl">12</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># update total_time and follow_time</span></span>
<span>  <span class="va">duration</span>                <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exp_duration.html">exp_duration</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span>, d<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">arm0</span><span class="op">$</span><span class="va">total_time</span>         <span class="op">&lt;-</span> <span class="va">duration</span></span>
<span>  <span class="va">arm0</span><span class="op">$</span><span class="va">follow_time</span>        <span class="op">&lt;-</span> <span class="va">duration</span> <span class="op">-</span> <span class="va">arm0</span><span class="op">$</span><span class="va">accr_time</span></span>
<span>  <span class="va">arm1</span><span class="op">$</span><span class="va">total_time</span>         <span class="op">&lt;-</span> <span class="va">duration</span></span>
<span>  <span class="va">arm1</span><span class="op">$</span><span class="va">follow_time</span>        <span class="op">&lt;-</span> <span class="va">duration</span> <span class="op">-</span> <span class="va">arm1</span><span class="op">$</span><span class="va">accr_time</span></span>
<span>  </span>
<span>  <span class="co"># record results</span></span>
<span>  <span class="va">optimal</span><span class="op">$</span><span class="va">total_time</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>   <span class="op">&lt;-</span> <span class="va">duration</span></span>
<span>  <span class="va">optimal</span><span class="op">$</span><span class="va">power</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>        <span class="op">&lt;-</span> <span class="fu"><a href="../reference/power_two_arm.html">power_two_arm</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span><span class="op">)</span></span>
<span>  <span class="va">optimal</span><span class="op">$</span><span class="va">events0</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>      <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exp_events.html">exp_events</a></span><span class="op">(</span><span class="va">arm0</span><span class="op">)</span></span>
<span>  <span class="va">optimal</span><span class="op">$</span><span class="va">events1</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>      <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exp_events.html">exp_events</a></span><span class="op">(</span><span class="va">arm1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">optimal</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 Ã— 10</span></span></span>
<span><span class="co">#&gt;      p1    HR accr_time     d     n     m total_time power events0 events1</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   0.5  0.3       12    29.0  48.3   6         23.1 0.888    19.4    9.63</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>   0.5  0.31      12.2  30.6  51.1   6.3       23.7 0.889    20.3   10.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   0.5  0.32      12.3  32.4  53.9   6.6       24.3 0.889    21.4   11.0 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   0.5  0.33      12.5  34.2  57.0   6.9       24.9 0.890    22.4   11.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>   0.5  0.34      12.7  36.1  60.1   7.2       25.4 0.891    23.6   12.6</span></span></code></pre></div>
<p>The following code produces Figure 1C:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">optimal</span>, <span class="va">HR</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">power</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">power</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># identify p1 that maximizes power</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>eprop<span class="op">=</span><span class="va">events1</span><span class="op">/</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">HR</span>, <span class="va">p1</span>, <span class="va">eprop</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">category</span>, <span class="va">prop</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>category<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">category</span><span class="op">==</span><span class="st">"p1"</span>, <span class="st">"Patients"</span>, <span class="st">"Events"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">HR</span>,y<span class="op">=</span><span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">category</span>, lty<span class="op">=</span><span class="va">category</span><span class="op">)</span>, lwd<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hazard ratio"</span>, </span>
<span>       y<span class="op">=</span><span class="st">"Proportion contributed by active arm"</span>,</span>
<span>       col<span class="op">=</span><span class="st">""</span>,</span>
<span>       lty<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-6-1.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="figure-2">Figure 2<a class="anchor" aria-label="anchor" href="#figure-2"></a>
</h2>
<p>Figure 2 can be produced via similar steps. Again, for sake of efficiency, a coarser grid of HRs will be considered here. Also, the empirical power based on simulations will not be calculated. First, we initialize the output table:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1.vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">/</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">HR.vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.9</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">p1.vec</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">HR.vec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  HR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">HR.vec</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">p1.vec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  accr_time <span class="op">=</span> <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR</span>, k<span class="op">=</span><span class="fl">2.3</span>, range.min<span class="op">=</span><span class="fl">12</span>, range.max<span class="op">=</span><span class="fl">48</span><span class="op">)</span>,</span>
<span>  d <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.9</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="fl">0.5</span><span class="op">/</span><span class="fl">0.5</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">HR</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="co"># schoenfeld 1981</span></span>
<span>  n <span class="op">=</span> <span class="va">d</span> <span class="op">/</span> <span class="fu">fun_hr</span><span class="op">(</span><span class="va">HR</span>, k<span class="op">=</span><span class="fl">5</span>, range.min<span class="op">=</span><span class="fl">0.6</span>, range.max<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span>,</span>
<span>  m <span class="op">=</span> <span class="fu">fun_hr</span><span class="op">(</span>HR<span class="op">=</span><span class="va">HR</span>, k<span class="op">=</span><span class="fl">0</span>, range.min<span class="op">=</span><span class="fl">6</span>, range.max<span class="op">=</span><span class="fl">24</span><span class="op">)</span>,</span>
<span>  ed <span class="op">=</span> <span class="fl">0</span>, <span class="co"># power, schoenfeld</span></span>
<span>  mu <span class="op">=</span> <span class="fl">0</span>, <span class="co"># power, recommended asymptotic approximation</span></span>
<span>  mu_b <span class="op">=</span> <span class="fl">0</span>, <span class="co"># power, block randomization</span></span>
<span>  mu_s <span class="op">=</span> <span class="fl">0</span>  <span class="co"># power, simple randomization</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we populate the table:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">fixed</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">R</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># scenario specific parameters</span></span>
<span>  <span class="va">p1</span>        <span class="op">&lt;-</span> <span class="va">fixed</span><span class="op">$</span><span class="va">p1</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">HR</span>        <span class="op">&lt;-</span> <span class="va">fixed</span><span class="op">$</span><span class="va">HR</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">accr_time</span> <span class="op">&lt;-</span> <span class="va">fixed</span><span class="op">$</span><span class="va">accr_time</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">d</span>         <span class="op">&lt;-</span> <span class="va">fixed</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">n</span>         <span class="op">&lt;-</span> <span class="va">fixed</span><span class="op">$</span><span class="va">n</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">m</span>         <span class="op">&lt;-</span> <span class="va">fixed</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># create arm objects</span></span>
<span>  <span class="va">arm0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_arm.html">create_arm</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">n</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p1</span><span class="op">)</span>,</span>
<span>                     accr_time<span class="op">=</span><span class="va">accr_time</span>,</span>
<span>                     accr_interval<span class="op">=</span><span class="va">accr_time</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>, <span class="co"># piecewise-uniform accrual</span></span>
<span>                     accr_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.25</span>,<span class="fl">0.7</span><span class="op">)</span>,</span>
<span>                     surv_scale<span class="op">=</span><span class="fu"><a href="../reference/per2haz.html">per2haz</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,</span>
<span>                     loss_scale<span class="op">=</span><span class="fu"><a href="../reference/per2haz.html">per2haz</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">*</span><span class="fl">0.05</span>,</span>
<span>                     follow_time<span class="op">=</span><span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="va">arm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_arm.html">create_arm</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">n</span><span class="op">*</span><span class="va">p1</span>,</span>
<span>                     accr_time<span class="op">=</span><span class="va">accr_time</span>,</span>
<span>                     accr_interval<span class="op">=</span><span class="va">accr_time</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                     accr_param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.25</span>,<span class="fl">0.7</span><span class="op">)</span>,</span>
<span>                     surv_scale<span class="op">=</span><span class="fu"><a href="../reference/per2haz.html">per2haz</a></span><span class="op">(</span><span class="va">m</span><span class="op">/</span><span class="va">HR</span><span class="op">)</span>,</span>
<span>                     loss_scale<span class="op">=</span><span class="va">arm0</span><span class="op">$</span><span class="va">loss_scale</span>,</span>
<span>                     follow_time<span class="op">=</span><span class="fl">12</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># update total_time and follow_time</span></span>
<span>  <span class="va">duration</span>                <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exp_duration.html">exp_duration</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span>, d<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">arm0</span><span class="op">$</span><span class="va">total_time</span>         <span class="op">&lt;-</span> <span class="va">duration</span></span>
<span>  <span class="va">arm0</span><span class="op">$</span><span class="va">follow_time</span>        <span class="op">&lt;-</span> <span class="va">duration</span> <span class="op">-</span> <span class="va">arm0</span><span class="op">$</span><span class="va">accr_time</span></span>
<span>  <span class="va">arm1</span><span class="op">$</span><span class="va">total_time</span>         <span class="op">&lt;-</span> <span class="va">duration</span></span>
<span>  <span class="va">arm1</span><span class="op">$</span><span class="va">follow_time</span>        <span class="op">&lt;-</span> <span class="va">duration</span> <span class="op">-</span> <span class="va">arm1</span><span class="op">$</span><span class="va">accr_time</span></span>
<span>  </span>
<span>  <span class="co"># record results</span></span>
<span>  <span class="va">fixed</span><span class="op">$</span><span class="va">ed</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>       <span class="op">&lt;-</span> <span class="fu"><a href="../reference/power_two_arm.html">power_two_arm</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span>, </span>
<span>                                     test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"weighted logrank"</span>, </span>
<span>                                               mean.approx<span class="op">=</span><span class="st">"event driven"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fixed</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>       <span class="op">&lt;-</span> <span class="fu"><a href="../reference/power_two_arm.html">power_two_arm</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span><span class="op">)</span></span>
<span>  <span class="va">fixed</span><span class="op">$</span><span class="va">mu_b</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>     <span class="op">&lt;-</span> <span class="fu"><a href="../reference/power_two_arm.html">power_two_arm</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span>, </span>
<span>                                     test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"weighted logrank"</span>, </span>
<span>                                               var.approx<span class="op">=</span><span class="st">"block"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fixed</span><span class="op">$</span><span class="va">mu_s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>     <span class="op">&lt;-</span> <span class="fu"><a href="../reference/power_two_arm.html">power_two_arm</a></span><span class="op">(</span><span class="va">arm0</span>, <span class="va">arm1</span>, </span>
<span>                                     test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"weighted logrank"</span>, </span>
<span>                                               var.approx<span class="op">=</span><span class="st">"simple"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>The following code produces Figure 2:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">fixed</span>, key<span class="op">=</span><span class="st">"approximation"</span>, value<span class="op">=</span><span class="st">"power"</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">HR</span>, y<span class="op">=</span><span class="va">power</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">approximation</span>, lty<span class="op">=</span><span class="va">approximation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">p1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hazard ratio"</span>,</span>
<span>       y<span class="op">=</span><span class="st">"Power"</span>,</span>
<span>       col<span class="op">=</span><span class="st">""</span>,</span>
<span>       lty<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Godwin Yung, Yi Liu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
